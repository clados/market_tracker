name: backend
type: Backend Service

# Application configuration
image:
  build: 
    dockerfile: ./backend/Dockerfile
    context: .
  port: 8000

# Health check
http:
  path: '/health'
  port: 8000
  healthy_threshold: 2
  unhealthy_threshold: 2
  timeout: 5s
  interval: 30s

# Scaling configuration
cpu: 512
memory: 1024
count: 1

# Network configuration
network:
  vpc:
    placement: private
    security_groups:
      - from_cfn: ${COPILOT_APPLICATION_NAME}-${COPILOT_ENVIRONMENT_NAME}-marketdbSecurityGroup

secrets:
  DB_SECRET:
    from_cfn: ${COPILOT_APPLICATION_NAME}-${COPILOT_ENVIRONMENT_NAME}-marketdbSecret

environments:
  staging:
    variables:
      ENVIRONMENT: staging
      LOG_LEVEL: DEBUG
      DB_HOST:
        from_cfn: ${COPILOT_APPLICATION_NAME}-${COPILOT_ENVIRONMENT_NAME}-marketdbEndpoint
      DB_NAME: marketdb
      DB_PORT: "5432"

# Outputs to export backend URL
outputs:
  backendURL:
    Description: "Backend service URL"
    Value: !Sub "http://${COPILOT_SERVICE_NAME}.${COPILOT_SERVICE_DISCOVERY_ENDPOINT}:8000"
    Export:
      Name: !Sub "${COPILOT_APPLICATION_NAME}-${COPILOT_ENVIRONMENT_NAME}-backendURL"

